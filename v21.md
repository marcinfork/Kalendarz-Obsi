```dataviewjs
/* ---------- Imports and Utils ---------- */
var { createEl } = this.app.dom;
var obsidian = require("obsidian"); // Required for MarkdownRenderer

// GLOBALNA KONFIGURACJA I STAN
// DomyÅ›lny folder to 'events', chyba Å¼e nie istnieje, wtedy pierwszy z listy
var state = {
    selectedFolder: "events",  
    view: "month",
    date: window.moment(),
    events: [],
    routines: [],
    fullWidth: false
};

function parseDate(v) {
  if (!v) return null;
  if (v?.format) return v; 
  var m = window.moment(String(v));
  if (!m.isValid()) m = window.moment(String(v), "YYYY-MM-DD");
  if (!m.isValid()) {
    var s = String(v).replace(/\./g, "-");
    m = window.moment(s, "YYYY-MM-DD");
  }
  return m.isValid() ? m : null;
}

// Funkcja pobierajÄ…ca wszystkie foldery w Vault
function getAllFolders() {
    var folders = app.vault.getAllLoadedFiles()
        .filter(f => f.children) // Filtruje tylko foldery (pliki nie majÄ… children)
        .map(f => f.path)
        .filter(p => p !== "/"); // Opcjonalnie usuÅ„ root, jeÅ›li chcesz
    return folders.sort();
}

/* ---------- Data Loading (Dynamic) ---------- */
function reloadData() {
    // Zapytanie Dataview zaleÅ¼ne od wybranego folderu
    var source = `"${state.selectedFolder}"`;
    
    state.events = dv.pages(source)
      .where(p => p.start)
      .map(p => {
        var s = parseDate(p.start);
        var e = p.end ? parseDate(p.end) : s;
        if (!s) return null;
        return { file: p.file, title: p.file.name, start: s, end: e || s, icon: p.icon || "", color: p.color || "#b3e5fc", image: p.image };
      })
      .filter(Boolean);

    state.routines = dv.pages(source)
      .where(p => p.date)
      .map(p => {
        var d = parseDate(p.date);
        if (!d) return null;
        return { file: p.file, date: d, activities: p.activities || [], title: p.file.name, image: p.image };
      })
      .filter(Boolean);
}

// Inicjalne Å‚adowanie danych
reloadData();


/* ---------- File Operations ---------- */

// Aktualizacja daty start (DRAG & DROP/LEFT RESIZE)
async function updateFileDate(file, newStartDate, field = 'start') {
    var content = await app.vault.read(file);
    var newDateStr = newStartDate.format("YYYY-MM-DD");
    var updatedContent = content;
    var regex = new RegExp(`(^---\\s*[\\s\\S]*?)${field}:\\s*(\\S+)([\\s\\S]*?^---)`, 'm');
    
    if (regex.test(content)) {
        updatedContent = content.replace(regex, (match, p1, p2, p3) => `${p1}${field}: ${newDateStr}${p3}`);
    } else if (field === 'start') {
        return;
    }
    await app.vault.modify(file, updatedContent);
}

// Aktualizacja daty zakoÅ„czenia (RIGHT RESIZE)
async function updateFileDateAndDuration(file, newEndDate) {
    var content = await app.vault.read(file);
    var newDateStr = newEndDate.format("YYYY-MM-DD");
    var updatedContent = content;
    var regexEnd = /(^---\s*[\s\S]*?)end:\s*(\S+)([\s\S]*?^---)/m;
    
    if (regexEnd.test(content)) {
        updatedContent = content.replace(regexEnd, (match, p1, p2, p3) => `${p1}end: ${newDateStr}${p3}`);
    } else {
        var regexYamlEnd = /(^---\s*[\s\S]*?^---)/m;
        updatedContent = content.replace(regexYamlEnd, (match) => match.replace(/---\s*$/, `end: ${newDateStr}\n---`));
    }
    await app.vault.modify(file, updatedContent);
}

// Tworzenie nowego pliku (QUICK ADD) - teraz w wybranym folderze
async function createNewEventFile(newStartDate) {
    var dateStr = newStartDate.format("YYYY-MM-DD");
    var title = `Wydarzenie ${newStartDate.format("YYYY-MM-DD_HHmm")}`;
    
    // UÅ¼yj wybranego folderu. JeÅ›li root, nie dodawaj slasha na poczÄ…tku
    var folderPath = state.selectedFolder === "/" ? "" : state.selectedFolder + "/";
    var path = `${folderPath}${title}.md`; 

    var newContent = `---
start: ${dateStr}
icon: ðŸ’¡
color: "#aed581"
image: 
---

## ${title}
Opis wydarzenia.
`;
    
    try {
        await app.vault.create(path, newContent);
        app.workspace.openLinkText(path, "", false); 
        // Poczekaj chwilÄ™ na indeksowanie i odÅ›wieÅ¼
        setTimeout(() => { reloadData(); render(dv.container); }, 300);
    } catch (e) {
        console.error("BÅ‚Ä…d:", e);
        alert(`BÅ‚Ä…d: Upewnij siÄ™, Å¼e folder '${state.selectedFolder}' istnieje.`);
    }
}


/* ---------- Rendering ---------- */
var resizeBound = false; 
var currentMonthBeforeRefresh = null; 

function render(container) {
  container.empty();
  
  if (currentMonthBeforeRefresh) {
      state.date = currentMonthBeforeRefresh;
      currentMonthBeforeRefresh = null;
  }

  // --- FULL WIDTH LOGIC ---
  // Find the parent view container (works in both Live Preview and Reading Mode)
  var viewContainer = container.closest('.markdown-preview-view') || container.closest('.markdown-source-view');
  
  if (viewContainer) {
      if (state.fullWidth) {
          viewContainer.classList.add('calendar-wrapper-full-width');
      } else {
          viewContainer.classList.remove('calendar-wrapper-full-width');
      }
  }

  var header = container.createEl("div", { cls: "calendar-header" });
  
  // 1. Lewa: Widoki
  var viewControls = header.createEl("div", { cls: "view-controls" });
  
  // 2. Åšrodek: Nawigacja
  var navContainer = header.createEl("div", { cls: "nav-controls-container" });

  // 3. Prawa: Akcje (Folder + Plus)
  var actionControls = header.createEl("div", { cls: "action-controls" });

  // --- BUTTONY WIDOKÃ“W ---
  function createViewButton(viewName, icon, tooltip) {
    var btn = viewControls.createEl("button", { 
        text: icon, 
        cls: state.view === viewName ? 'active-view' : '' 
    });
    btn.title = tooltip;
    btn.onclick = () => {
      state.view = viewName;
      render(container);
    };
  }
  createViewButton("month", "ðŸ“…", "Widok MiesiÄ™czny");
  createViewButton("year-scrollable", "ðŸ“œ", "Widok Roczny (Przewijany)");
  createViewButton("year-grid", "ðŸ“Š", "Widok Roczny (Siatka)");
  
  // --- DROPDOWN WYBORU FOLDERU ---
  var folderSelect = actionControls.createEl("select", { cls: "folder-dropdown" });
  var allFolders = getAllFolders();
  
  // JeÅ›li folderu z ustawieÅ„ nie ma na liÅ›cie (np. usuniÄ™ty), ustaw pierwszy dostÄ™pny
  if (!allFolders.includes(state.selectedFolder) && allFolders.length > 0) {
      state.selectedFolder = allFolders[0];
  }

  allFolders.forEach(f => {
      var opt = folderSelect.createEl("option", { text: f, value: f });
      if (f === state.selectedFolder) opt.selected = true;
  });

  folderSelect.onchange = async (e) => {
      var newFolder = e.target.value;
      state.selectedFolder = newFolder;
      
      // Self-modifying code: Zapisz wybÃ³r bezpoÅ›rednio w kodzie tego pliku
      try {
        var file = app.vault.getAbstractFileByPath(dv.current().file.path);
        var content = await app.vault.read(file);
        
        // Regex szukajÄ…cy linii: selectedFolder: "tekst",
        // Zmieniamy tylko pierwsze wystÄ…pienie w obiekcie state
        var updatedContent = content.replace(/(selectedFolder:\s*")(.+?)(")/, `$1${newFolder}$3`);
        
        await app.vault.modify(file, updatedContent);
      } catch (err) {
        console.error("Nie udaÅ‚o siÄ™ zmodyfikowaÄ‡ kodu:", err);
      }

      reloadData(); 
      render(container); 
  };

  // --- FULLSCREEN BUTTON ---
  var fullScreenBtn = actionControls.createEl("button", { 
      text: state.fullWidth ? "ðŸ¤" : "â†”ï¸", 
      cls: state.fullWidth ? "active-view" : "" 
  });
  fullScreenBtn.title = state.fullWidth ? "PrzywrÃ³Ä‡ szerokoÅ›Ä‡" : "PeÅ‚na szerokoÅ›Ä‡";
  fullScreenBtn.onclick = () => {
      state.fullWidth = !state.fullWidth;
      render(container);
  };

  // --- PRZYCISK PLUS ---
  var addBtn = actionControls.createEl("button", { text: "âž•", cls: "add-event-btn" });
  addBtn.title = `Dodaj wydarzenie w: ${state.selectedFolder}`;
  addBtn.onclick = () => createNewEventFile(window.moment());


  // --- RENDEROWANIE WIDOKÃ“W ---
  if (state.view === "month") {
      renderMonth(container, navContainer);
  } else if (state.view === "year-scrollable") {
      renderYearScrollable(container, navContainer);
  } else if (state.view === "year-grid") {
      renderYearGrid(container, navContainer);
  }

  if (!resizeBound) { 
    resizeBound = true;
    window.addEventListener("resize", () => render(container)); 
  }
}

render(dv.container);


/* ================= MONTH VIEW ================= */
function renderMonth(container, navContainer) {
  var prevBtn  = navContainer.createEl("button", { text: "â¬…" });
  var title    = navContainer.createEl("span",   { text: state.date.format("MMMM YYYY"), cls: "month-title" });
  var nextBtn  = navContainer.createEl("button", { text: "âž¡" });
  var todayBtn = navContainer.createEl("button", { text: "DziÅ›" });

  prevBtn.onclick  = () => { state.date = state.date.clone().subtract(1,"month"); render(container); };
  nextBtn.onclick  = () => { state.date = state.date.clone().add(1,"month"); render(container); };
  todayBtn.onclick = () => { state.date = window.moment(); render(container); };

  var daysRow = container.createEl("div", { cls: "calendar-days" }); 
  ["Pon","Wto","Åšro","Czw","PiÄ…","Sob","Nie"].forEach(d => 
    daysRow.createEl("div", { text: d, cls: "day-name" })
  );

  var startOfMonth = state.date.clone().startOf("month").startOf("isoWeek");
  var endOfMonth   = state.date.clone().endOf("month").endOf("isoWeek");

  var weekStart = startOfMonth.clone();
  while (weekStart.isBefore(endOfMonth)) {
    renderWeek(container, weekStart.clone(), false); 
    weekStart.add(1, "week");
  }
}

/* ================= WEEK RENDER ================= */
function renderWeek(container, start, isGridMode = false) {
  var end = start.clone().add(6, "days");
  // Hoisted for usage in day loop
  var weekEvents = state.events.filter(ev => ev.start.isSameOrBefore(end,"day") && ev.end.isSameOrAfter(start,"day"));
  var week = container.createEl("div", { cls: "week-grid" });

  var slotVerticalSpace = isGridMode ? 16 : 20; 
  var initialTop = isGridMode ? 18 : 25; 

  var dayCells = []; 
  for (var i = 0; i < 7; i++) {
    var day  = start.clone().add(i, "day");
    var cell = week.createEl("div", { cls: "day-cell" });
    cell.createEl("div", { cls: "day-number", text: day.date() });
    
    cell.setAttribute('data-date', day.format('YYYY-MM-DD'));
    dayCells.push(cell); 

    // QUICK ADD on Double Click
    if (!isGridMode) {
        cell.addEventListener('dblclick', function(e) {
            e.stopPropagation();
            currentMonthBeforeRefresh = state.date.clone(); 
            var targetDate = window.moment(e.currentTarget.getAttribute('data-date'));
            createNewEventFile(targetDate);
        });
    }

    // Routines
    var dayRoutines = state.routines.filter(r => r.date.isSame(day, "day"));
    
    // IMAGE BACKGROUND LOGIC
    var bgRoutine = dayRoutines.find(r => r.image);
    var bgEvent = !bgRoutine ? weekEvents.find(ev => ev.image && ev.start.isSame(day, 'day')) : null; 
    
    var visibleImage = bgRoutine ? bgRoutine.image : (bgEvent ? bgEvent.image : null);

    if (visibleImage) {
        var isLink = false;
        var linkText = "";
        
        // Match [[Link]] or ![[Link]]
        var linkMatch = typeof visibleImage === 'string' ? visibleImage.match(/\[\[(.*?)\]\]/) : null;
        if (linkMatch) {
            linkText = linkMatch[1].split('|')[0];
            isLink = true;
        } else if (typeof visibleImage === 'object' && visibleImage.path) {
            linkText = visibleImage.path;
            isLink = true;
        } else if (typeof visibleImage === 'string') {
            linkText = visibleImage;
        }

        // Check if it's a standard image file
        var isStandardImage = linkText.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp)$/i) || linkText.startsWith("http");

        if (isStandardImage) {
            // === METHOD A: STANDARD BACKGROUND IMAGE (Robust) ===
            var imgUrl = linkText;
            if (!linkText.startsWith("http")) {
                 var file = app.metadataCache.getFirstLinkpathDest(linkText, dv.current().file.path);
                 if (file) imgUrl = app.vault.getResourcePath(file);
            }
            
            cell.style.backgroundImage = `url('${imgUrl}')`;
            cell.style.backgroundSize = "100% 100%"; 
            cell.addClass("has-background-image");
            
        } else {
            // === METHOD B: MARKDOWN EMBED (For Excalidraw, etc.) ===
            var embedContainer = cell.createEl("div", { cls: "cell-embed-container" });
            
            // Construct ![[path]]
            // Use linkText which handles both strings and objects
            var embedString = `![[${linkText}]]`;
             
            obsidian.MarkdownRenderer.render(app, embedString, embedContainer, dv.current().file.path, new obsidian.Component());
            cell.addClass("has-background-image");
        }
    }

    if (dayRoutines.length) {
      var rc = cell.createEl("div", { cls: "routine-container" });
      dayRoutines.forEach(r => {
        if (r.activities && r.activities.length) {
          var el = rc.createEl("span", { cls: "routine-icons", text: r.activities.join("") });
          el.onclick = (e) => { e.stopPropagation(); app.workspace.openLinkText(r.file.path, "", false); };
        }
      });
    }

    // Weekend Colors
    if (day.day() === 6 || day.day() === 0) cell.addClass("weekend");
    if (day.isSame(window.moment(),"day")) cell.addClass("today");
  }

  // Events logic
  // var weekEvents defined at top of function
  var daySlots = Array(7).fill(null).map(() => new Set());
  var eventSlots = new Map();
  
  weekEvents.forEach(ev => {
    var evStart    = window.moment.max(ev.start, start);
    var evEnd      = window.moment.min(ev.end,   end);
    var startIndex = evStart.diff(start, "days");
    var endIndex   = evEnd.diff(start, "days");

    var slot = 0;
    while ([...Array(endIndex - startIndex + 1).keys()].some(i => daySlots[startIndex+i].has(slot))) {
      slot++;
    }
    eventSlots.set(ev, slot);
    for (var i = startIndex; i <= endIndex; i++) daySlots[i].add(slot);

    var el = week.createEl("a", { cls: "event-bar" });
    el.innerHTML = `${ev.icon} ${ev.title}`;
    el.href = ev.file.path;
    el.style.backgroundColor = ev.color;
    el.onclick = (e) => { e.preventDefault(); app.workspace.openLinkText(ev.file.path, "", false); };

    el.style.position = "absolute";
    el.style.top  = (initialTop + slot * slotVerticalSpace) + "px";
    el.style.left = `calc(${(startIndex * 14.2857)}% + 2px)`;
    el.style.width= `calc(${((endIndex - startIndex + 1) * 14.2857)}% - 4px)`;
    
    // --- DRAG & DROP & RESIZE Logic (only for Month View) ---
    if (!isGridMode) { 
        el.setAttribute('draggable', 'true');
        el.setAttribute('data-filepath', ev.file.path);
        el.setAttribute('data-startdate', ev.start.format('YYYY-MM-DD'));
        el.addClass('draggable-event');

        el.addEventListener('dragstart', function(e) {
            e.stopPropagation();
            e.dataTransfer.setData('text/plain', e.target.getAttribute('data-filepath'));
            e.dataTransfer.setData('data-startdate', e.target.getAttribute('data-startdate'));
            e.target.style.opacity = '0.4'; 
        });
        el.addEventListener('dragend', function(e) { e.target.style.opacity = '1'; });

        dayCells.forEach(cell => {
            cell.addEventListener('dragover', function(e) { e.preventDefault(); e.currentTarget.classList.add('drag-hover'); });
            cell.addEventListener('dragleave', function(e) { e.currentTarget.classList.remove('drag-hover'); });
            cell.addEventListener('drop', function(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-hover');
                var filePath = e.dataTransfer.getData('text/plain');
                var oldStartDate = window.moment(e.dataTransfer.getData('data-startdate'));
                var newDateStr = e.currentTarget.getAttribute('data-date');
                var newStartDate = window.moment(newDateStr);
                var diff = newStartDate.diff(oldStartDate, 'days');
                var finalNewDate = oldStartDate.clone().add(diff, 'days');
                var fileToUpdate = app.vault.getAbstractFileByPath(filePath);
                if (fileToUpdate) {
                    currentMonthBeforeRefresh = state.date.clone(); 
                    updateFileDate(fileToUpdate, finalNewDate, 'start').then(() => { reloadData(); render(dv.container); });
                }
            });
        });

        // Resize Handlers (uproszczone dla czytelnoÅ›ci, logika taka sama jak w poprzednim kodzie)
        var createResizeHandler = (side) => {
             var handle = el.createEl('div', { cls: `resize-handle resize-handle-${side}` });
             handle.addEventListener('mousedown', function(e) {
                e.stopPropagation(); e.preventDefault();
                var eventFile = app.vault.getAbstractFileByPath(ev.file.path);
                var initialX = e.clientX;
                var currentWeekGrid = week;
                var dayCellWidth = currentWeekGrid.getBoundingClientRect().width / 7;

                function onMouseMove(moveE) {
                    // Wizualne przesuwanie (opcjonalne, w poprzednim kodzie byÅ‚o dokÅ‚adne)
                }
                function onMouseUp(upE) {
                    document.removeEventListener('mouseup', onMouseUp);
                    var deltaX = upE.clientX - initialX;
                    var daysToMove = Math.round(deltaX / dayCellWidth);
                    
                    if (daysToMove !== 0) {
                        currentMonthBeforeRefresh = state.date.clone();
                        if (side === 'right') {
                            var newEndMoment = ev.end.clone().add(daysToMove, 'days');
                            var targetDate = newEndMoment.isSameOrAfter(ev.start, 'day') ? newEndMoment : ev.start;
                            updateFileDateAndDuration(eventFile, targetDate).then(() => { reloadData(); render(dv.container); });
                        } else {
                            var newStartMoment = ev.start.clone().add(daysToMove, 'days');
                            var targetDate = newStartMoment.isSameOrBefore(ev.end, 'day') ? newStartMoment : ev.end;
                            updateFileDate(eventFile, targetDate, 'start').then(() => { reloadData(); render(dv.container); });
                        }
                    }
                }
                document.addEventListener('mouseup', onMouseUp);
             });
        };
        createResizeHandler('left');
        createResizeHandler('right');
    }
  });

  var maxSlot = Math.max(0, ...eventSlots.values());
  week.style.minHeight = Math.max(70, initialTop + (maxSlot+1) * slotVerticalSpace + 10) + "px"; 
}


/* ================= SCROLLABLE YEAR ================= */
function renderYearScrollable(container, navContainer) {
  navContainer.createEl("button", { text: "â—€", onclick: () => { state.date = state.date.clone().subtract(1, "year"); render(dv.container); } });
  navContainer.createEl("span", { cls: "month-title", text: state.date.format("YYYY") });
  navContainer.createEl("button", { text: "â–¶", onclick: () => { state.date = state.date.clone().add(1, "year"); render(dv.container); } });
  navContainer.createEl("button", { text: "DziÅ›", onclick: () => { state.date = window.moment(); render(dv.container); } });

  var scrollWrapper = container.createEl("div", { cls: "year-scroll-wrapper" });
  var wh = scrollWrapper.createEl("div", { cls: "year-week-header" });
  wh.createEl("div", { cls: "header-spacer" });
  var daysHeader = wh.createEl("div", { cls: "header-days" });
  
  var weekDays = ["Pn","Wt","Åšr","Cz","Pt","Sb","Nd"];
  for(var w=0; w<6; w++) {
      weekDays.forEach((d, idx) => {
          var dh = daysHeader.createEl("div", { text: d, cls: "header-day-label" });
          if (idx >= 5) dh.addClass("weekend-label");
      });
  }

  var grid = scrollWrapper.createEl("div", { cls: "year-grid-scrollable" });
  var year = state.date.year();
  var slotVerticalSpace = 20; 
  
  for (var m = 0; m < 12; m++) {
    var row = grid.createEl("div", { cls: "year-row" });
    row.createEl("div", { cls: "year-month-name", text: window.moment([year, m]).format("MMM") });
    var daysContainer = row.createEl("div", { cls: "year-days-container" });

    var monthStart = window.moment([year, m, 1]);
    var monthEnd = monthStart.clone().endOf("month");
    var offset = (monthStart.day() + 6) % 7; // ISO Fix
    
    for (var i = 0; i < 42; i++) {
      var d = i - offset + 1;
      var cell = daysContainer.createEl("div", { cls: "year-day-cell" });
      if (d >= 1 && d <= monthStart.daysInMonth()) {
          var day = window.moment([year, m, d]);
          cell.createEl("div", { text: d, cls: "day-number" });
          if (day.day() === 6 || day.day() === 0) cell.addClass("weekend");
          if (day.isSame(window.moment(), "day")) cell.addClass("today");
          // Routines in scroll view...
      } else {
          cell.addClass("empty");
      }
    }
    // Event rendering for scroll view (uproszczone: uÅ¼ywa state.events)
    var monthEvents = state.events.filter(ev => ev.start.isSameOrBefore(monthEnd, "day") && ev.end.isSameOrAfter(monthStart, "day"));
    var slots = [];
    monthEvents.forEach(ev => {
      var s = window.moment.max(ev.start, monthStart);
      var e = window.moment.min(ev.end, monthEnd);
      var startIndex = offset + s.date() - 1;
      var span = e.diff(s, "days") + 1;
      var slot = 0;
      while (slots.some(sl => !(startIndex + span - 1 < sl.start || startIndex > sl.end) && sl.slot === slot )) slot++;
      slots.push({ start: startIndex, end: startIndex + span - 1, slot });

      var bar = daysContainer.createEl("a", { cls: "event-bar-year", text: `${ev.icon} ${ev.title}` });
      bar.style.background = ev.color;
      bar.style.left = `${startIndex * (100/42)}%`;
      bar.style.width = `${span * (100/42)}%`; 
      bar.style.top = `${24 + slot * slotVerticalSpace}px`;
      bar.onclick = (e) => { e.preventDefault(); app.workspace.openLinkText(ev.file.path, "", false); };
    });
    daysContainer.style.height = `${Math.max(28, 24 + ((Math.max(-1, ...slots.map(s=>s.slot)) + 1) * slotVerticalSpace) + 6)}px`;
  }
}

/* ================= YEAR GRID ================= */
function renderYearGrid(container, navContainer) {
  var prevBtn  = navContainer.createEl("button", { text: "â—€" }); 
  var title    = navContainer.createEl("span",   { text: state.date.format("YYYY"), cls: "month-title" }); 
  var nextBtn  = navContainer.createEl("button", { text: "â–¶" }); 
  var todayBtn = navContainer.createEl("button", { text: "DziÅ›" }); 

  prevBtn.onclick  = () => { state.date = state.date.clone().subtract(1,"year"); render(container); };
  nextBtn.onclick  = () => { state.date = state.date.clone().add(1,"year"); render(container); };
  todayBtn.onclick = () => { state.date = window.moment(); render(container); };

  var year = state.date.year();
  var grid = container.createEl("div", { cls: "year-grid-multi" }); 

  for (var m = 0; m < 12; m++) {
    var month = window.moment([year, m]);
    var monthContainer = grid.createEl("div", { cls: "month-container" });
    monthContainer.createEl("div", { cls: "month-title-small", text: month.format("MMMM") });
    var daysRow = monthContainer.createEl("div", { cls: "calendar-days-small" });
    ["Pon","Wto","Åšro","Czw","PiÄ…","Sob","Nie"].forEach(d => daysRow.createEl("div", { text: d, cls: "day-name-small" }));
    
    var monthGrid = monthContainer.createEl("div", { cls: "month-grid" });
    var startOfMonth = month.clone().startOf("month").startOf("isoWeek"); 
    var endOfMonth = month.clone().endOf("month").endOf("isoWeek");

    var weekStart = startOfMonth.clone();
    while (weekStart.isBefore(endOfMonth)) {
      renderWeek(monthGrid, weekStart.clone(), true); 
      weekStart.add(1,"week");
    }
  }
}


/* ---------- Styles ---------- */
var style = document.createElement("style");
style.textContent = `
/* FULL WIDTH OVERRIDES */
.calendar-wrapper-full-width .markdown-preview-sizer,
.calendar-wrapper-full-width .cm-contentContainer {
    max-width: 98% !important;
    width: 98% !important;
    margin: 0 auto !important;
}
.calendar-wrapper-full-width .markdown-source-view.mod-cm6 .cm-content {
    max-width: 98% !important;
    margin: 0 auto !important;
}

/* UI HEADER */
.calendar-header { display:flex; justify-content:space-between; align-items: center; gap: 10px; margin:10px 0; }
.view-controls { display: flex; gap: 5px; flex-basis: 150px; }
.nav-controls-container { display: flex; gap: 10px; flex-grow: 1; justify-content: center; }
.action-controls { display: flex; gap: 5px; flex-basis: 200px; justify-content: flex-end; align-items: center; }

.folder-dropdown {
    font-size: 0.9em;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid var(--background-modifier-border);
    background: var(--background-primary);
    color: var(--text-normal);
    max-width: 120px;
}

.calendar-header button { padding: 5px 10px; cursor: pointer; border: 1px solid var(--background-modifier-border); background: var(--background-primary); border-radius: 4px; }
.calendar-header button.active-view { background: var(--text-accent); color: var(--text-on-accent); border-color: var(--text-accent); }
.add-event-btn { font-weight: bold; color: var(--text-accent); font-size: 1.1em; }
.month-title { font-size: 1.2em; font-weight: bold; min-width: 100px; text-align: center; }

/* EVENTS & BARS */
.event-bar, .event-bar-year { height: 18px; line-height: normal; display: flex; align-items: center; text-decoration:none; color:#333; overflow:hidden; white-space:nowrap; z-index: 10; background:#b3e5fc; border-radius:3px; padding:2px 5px; }
.event-bar { font-size:0.8em; cursor: grab; }
.event-bar:hover { background:#81d4fa; }
.event-bar-year { position: absolute; font-size: 0.65em; padding: 0 4px; transform: translateX(1px); width: calc(100% - 2px); cursor: pointer; }

/* MONTH GRID */
.calendar-days { display:grid; grid-template-columns:repeat(7,1fr); font-weight:bold; text-align:center; margin-bottom:5px; }
.week-grid { display:grid; grid-template-columns:repeat(7,1fr); border-bottom:1px solid #ddd; position:relative; min-height:90px; }
.day-cell { border:1px solid #eee; padding:2px; position:relative; }
.day-cell.has-background-image .day-number { color: white; text-shadow: 0 0 3px black; }
.cell-embed-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; opacity: 0.6; pointer-events: none; }
.cell-embed-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; opacity: 0.6; pointer-events: none; display: flex; flex-direction: column; }
.cell-embed-container * {
    width: 100% !important;
    height: 100% !important;
    min-height: 0 !important;
    max-height: 100% !important;
    min-width: 0 !important;
    max-width: 100% !important;
    object-fit: fill !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    box-sizing: border-box !important;
}
.cell-embed-container .markdown-embed-link { display: none !important; }
.cell-embed-container .markdown-preview-view { padding: 0 !important; margin: 0 !important; }
.cell-embed-container p { margin: 0 !important; padding: 0 !important; }

.day-number { font-size:0.8em; font-weight:bold; position: relative; z-index: 5; }
.day-cell.weekend { background:#f3f3f3; }
.day-cell.today { background:#ffe0b2; }
.day-cell.drag-hover { box-shadow: inset 0 0 0 3px var(--text-accent); z-index: 15; }

/* RESIZE */
.resize-handle { position: absolute; top: 0; bottom: 0; width: 6px; cursor: ew-resize; z-index: 20; }
.resize-handle-right { right: 0; }
.resize-handle-left { left: 0; }
.day-cell.resize-hover { box-shadow: inset 0 0 0 3px var(--color-red); z-index: 15; }

/* ROUTINES */
.routine-container { position:absolute; bottom:2px; left:2px; right:2px; text-align:center; z-index:10; }
.routine-icons { font-size:0.9em; cursor:pointer; padding:1px 2px; border-radius:3px; display:inline-block; margin:0 1px; }

/* YEAR GRID */
.year-grid-multi { display: grid; grid-template-columns: 1fr; gap: 20px; }
.month-container { border: 1px solid var(--background-modifier-border); padding: 5px; border-radius: 6px; }
.month-title-small { text-align: center; font-weight: bold; margin-bottom: 5px; }
.calendar-days-small { display: grid; grid-template-columns: repeat(7, 1fr); font-weight: bold; text-align: center; margin-bottom: 2px; font-size: 0.7em; }
.month-grid .week-grid { min-height: 50px; }
.month-grid .day-cell { padding: 1px; }

/* SCROLLABLE YEAR */
.year-scroll-wrapper { overflow-x: auto; padding-bottom: 10px; border: 1px solid #eee; }
.year-week-header { display: flex; margin-bottom: 4px; min-width: calc(60px + (42 * 28px)); border-bottom: 1px solid #ddd; background-color: var(--background-primary); position: sticky; top: 0; z-index: 20; }
.header-spacer { width: 60px; flex-shrink: 0; background: var(--background-primary); z-index:21; position:sticky; left:0;}
.header-days { flex-grow: 1; display: grid; grid-template-columns: repeat(42, 1fr); font-weight: bold; text-align: center; font-size: 0.7em; color: var(--text-muted); }
.header-day-label { padding: 2px 0; }
.header-day-label.weekend-label { color: var(--text-accent); }
.year-grid-scrollable { display: flex; flex-direction: column; }
.year-row { display: flex; border-bottom: 1px solid #ddd; min-width: calc(60px + (42 * 28px)); }
.year-month-name { width: 60px; flex-shrink: 0; font-weight: bold; text-align: right; padding-right: 6px; padding-top: 4px; background: var(--background-primary); position: sticky; left: 0; z-index: 15; border-right: 1px solid #eee; }
.year-days-container { flex-grow: 1; position: relative; display: grid; grid-template-columns: repeat(42, 1fr); }
.year-day-cell { border-left: 1px solid #f0f0f0; font-size: 0.65em; text-align: right; padding: 1px; box-sizing: border-box; height: 100%; z-index: 1; min-width: 28px; }
.year-day-cell.empty { background: transparent; }
.year-day-cell.weekend { background: rgba(0,0,0,0.03); }
.year-day-cell.today { background: rgba(255, 165, 0, 0.2); }
`;
var oldStyle = document.querySelector("#calendar-style-fix");
if (oldStyle) oldStyle.remove();
style.id = "calendar-style-fix";
document.head.appendChild(style);
```